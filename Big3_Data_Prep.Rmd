---
title: "R Notebook"
output: html_notebook
---

The goal of this project is to investigate how partnerships involving multiple top-tier players in the NBA impacts various performance measures and team outcomes. Among the research questions we would like to explore are the following:

*[ INSERT RESEARCH QUESTIONS HERE ]*

To be able to investigate, we need to pull data from multiple NBA seasons. The script below provides code to create functions that pull traditional stats for every player for a given user-defined season.

Load necessary libraries
```{r}
library(rvest)
library(dplyr)
library(tidyverse)
```

Function to get NBA roster for a specified year
```{r}
get_nba_roster <- function(year) {
  # Construct the URL for the specified year
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_per_game.html")
  
  # Read the HTML content from the URL
  webpage <- read_html(url)


  # Extract the table containing the player statistics
  roster_table <- webpage %>%
    html_node("table#per_game_stats") %>%
    html_table(fill = TRUE)
  
  # Clean the data (remove header rows that might be duplicated)
  roster_table <- roster_table %>%
    filter(Player != "Player")
    return(roster_table)
}
```

Example usage
```{r}
year <- 2018  # Specify the year
nba_roster <- get_nba_roster(year)

#Print the first few rows of the roster
head(nba_roster)
tail(nba_roster)

```
```{r}
#Summary statistics

position_roster<-filter(nba_roster,Pos!="PG" )
```



```{r}
#Data Visualization for Minutes Played vs Points Scored
input <- nba_roster[, c('MP', 'PTS')]
print(head(input))

# Get the input values.
input <- nba_roster[, c('MP', 'PTS')]

# Plot the chart for cars with
# weight between 1.5 to 4 and
# mileage between 10 and 25.
plot(x = input$MP, y = input$PTS,
	xlab = "Minutes Played",
	ylab = "Points",
	xlim = c(0.0, 48),
	ylim = c(0.0, 35),	 
	main = "Minutes Played vs Points Scored"
)

```
```{r}
#Data Visualization for Field Goals Attempled vs Field Goals Made
input_2 <- nba_roster[, c('FGA', 'FG')]
print(head(input_2))

# Get the input values.
input_2 <- nba_roster[, c('FGA', 'FG')]

# Plot the chart for players with
# field goal attempts between 0.0 to 25.0 and
# Field Goal Made between 0.0 and 25.0
plot(x = input_2$FGA, y = input_2$PTS,
	xlab = "Field Goal Attempts",
	ylab = "Field Goal Made",
	xlim = c(0.0, 35.0),
	ylim = c(0.0, 25.0),	 
	main = "Field Goal Attempt vs Field Goal Made"
)

```


```{r}
# Create the data for the chart
A <- c(nba_roster$PTS)
B <- c("PF", "PG", "SF", "C", "SG")

# Plot the bar chart
ggplot(nba_roster, aes(x=Pos, fill=PTS))+  

geom_bar()+  

theme_classic(16)+  

xlab("Position")+  

ylab("Points") 

```


**ASSIGNMENT 1:** *Is the data "clean"? Are there any missing values to be accounted for/addressed? If there are any data quality issues,*

 - *a. propose a method to resolve them*
       
Initial thought to change the default character to double given that we have fractioned values. i think the columns should be changed from " chararcter" to "double" 


 - *b. justify the validity of your approach*
removing observations with missing data from the dataset, using the function "na.omit" which will remove rows with missing values from our dataset


 - *c. implement your proposed changes*


For players who are missing data
```{r}
nba_roster<-na.omit(nba_roster)

nba_roster




# Convert specific columns from character to double
# Convert all character columns to double
nba_roster %>%
   mutate(across(G:PTS, as.numeric))



```

To determine whether a player is "top tier" and should be considered a part of a "Big 3" lineup, other authors have transformed traditional stats to create metrics such as

PRA = POINTS + REBOUNDS + ASSISTS 

We will consider advanced statistics such as PLAYER EFFIFIENCY RATING:

PER = (PTS + REB + AST + STL + BLK − Missed FG − Missed FT - TO) /GP

In particular, Value over Replacement (VORP) seems to do a solid job of identifying the best players in the league.

The script below provide code to create functions that pull advanced stats for every player for a given user-defined season.
```{r}

# Function to get NBA advanced stats for a specified year
get_nba_advanced_stats <- function(year) {
  # Construct the URL for the specified year
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_advanced.html")
  
  # Read the HTML content from the URL
  webpage <- read_html(url)
  
  # Extract the table containing the advanced player statistics
  advanced_stats_table <- webpage %>%
    html_node("table#advanced_stats") %>%
    html_table(fill = TRUE)
  
  # Clean the data (remove header rows that might be duplicated)
 # advanced_stats_table <- advanced_stats_table %>%
  #  filter(Player != "Player")
  
  return(advanced_stats_table)
}

# Example usage
year <- 2018  # Specify the year
nba_advanced_stats <- get_nba_advanced_stats(year)

# Print the first few rows of the advanced stats
head(nba_advanced_stats)


```

**ASSIGNMENT 2:** *Is the advanced data "clean"? Are there any missing values to be accounted for/addressed? If there are any data quality issues,*

 - *a. propose a method to resolve them*

 - *b. justify the validity of your approach*

 - *c. implement your proposed changes*
 
 cleaning similar to first one 
 
 
 The script below provide code to clean out the quality issues presented in the dataframe
 
 
 
```{r}
#1 We want to order the athletes name to alphabetical order to clean out the filler headers present

newdataframe<- dataframe[order(dataframe$Player)]

#2 Now we want to remove the filler rows that had been used as headers on the webpage

newdata.frame<-dataframe[-c(502:526), ]

#3 now we want to remove all the N/As from the dataset
dataframe %>% 
  select(where(~!all(is.na(.))))
```
 
 
 
```{r}

#want to order by alphabetic name to make cleaning out the filler headers from the dataset
AO_nba_advanced_stats <- nba_advanced_stats[order(nba_advanced_stats$Player),]



# remove filler rows that had been previously used as headers on webpage
AO_nba_advanced_stats<- AO_nba_advanced_stats[-c(502:526), ]


#remove na from dataframe
AO_nba_advanced_stats %>% 
  select(where(~!all(is.na(.))))
#removing column 20 and 25 from dataframe since theyre blanks
AO_nba_advanced_stats<-AO_nba_advanced_stats[,-20]
AO_nba_advanced_stats<-AO_nba_advanced_stats[,-24]


#change range of cloumns <dbl> from <chr>

AO_nba_advanced_stats %>%
   mutate(across(G:VORP, as.numeric))




```


**ASSIGNMENT 3:** *Merge the cleaned up datasets to create one new data frame with the traditional and advanced stats.*



```{r}
#how to merge two files into one new data frame
nba_merge<-merge(nba_roster, AO_nba_advanced_stats, by.x = c("Rk", "Player", "Pos","Age", "Tm","G"), by.y = c("Rk", "Player", "Pos","Age", "Tm","G") , all.x = TRUE, all.y = TRUE)


head(nba_merge)
```


**ASSIGNMENT 4:** *Make a function with argument `year` that outputs one dataframe with the merged traditional and advanced data.* 

```{r}

# Load necessary libraries
library(rvest)
library(dplyr)

# Function to get NBA roster stats for a specified year
get_nba_roster2 <- function(year) {
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_per_game.html")
  webpage <- read_html(url)
  roster_table <- webpage %>%
    html_node("table#per_game_stats") %>%
    html_table(fill = TRUE)
  
  # Clean up column names
  colnames(roster_table) <- make.names(colnames(roster_table), unique = TRUE)
  
  # Clean the data
  roster_table <- roster_table %>%
    filter(!is.na(Player) & Player != "Player") # Ensure no NA or duplicate header rows
  
  return(roster_table)
}

# Function to get NBA advanced stats for a specified year
get_nba_advanced_stats <- function(year) {
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_advanced.html")
  webpage <- read_html(url)
  advanced_stats_table <- webpage %>%
    html_node("table#advanced_stats") %>%
    html_table(fill = TRUE)
  
  # Clean up column names
  colnames(advanced_stats_table) <- make.names(colnames(advanced_stats_table), unique = TRUE)
  
  # Clean the data
  advanced_stats_table <- advanced_stats_table %>%
    filter(!is.na(Player) & Player != "Player") # Ensure no NA or duplicate header rows
  
  return(advanced_stats_table)
}

# Function to merge NBA roster and advanced stats for a specified year
get_cleaned_nba_stats <- function(year) {
  nba_roster2 <- get_nba_roster2(year)
  nba_advanced_stats2 <- get_nba_advanced_stats(year)
  
  # Check for the columns in both datasets before merging
  common_columns <- intersect(names(nba_roster2), names(nba_advanced_stats2))
  
  # Merge the datasets on common columns such as "Player", "Pos", "Age", "G", "MP"
  nba_merge <- merge(nba_roster2, nba_advanced_stats2, by = c("Player", "Pos", "Age", "G", "MP"), all.x = TRUE, all.y = TRUE)
  
  # Ensure there is a "Tm" column in the merged data
  if ("Tm" %in% names(nba_merge)) {
    # Remove any rows with multi-team entries like "2Tm", "3Tm", etc.
    nba_merge <- nba_merge %>%
      filter(!grepl("Tm", Tm))
  } else if ("Tm.x" %in% names(nba_merge) & "Tm.y" %in% names(nba_merge)) {
    # If Tm.x and Tm.y exist after the merge, combine them into one "Team" column
    nba_merge <- nba_merge %>%
      mutate(Team = coalesce(Tm.x, Tm.y)) %>%  # Coalesce merges both columns into one
      select(-Tm.x, -Tm.y)                     # Remove the old "Tm" columns
  }
  
  # Add a new column "VORP+PER" that sums VORP and PER
  nba_merge <- nba_merge %>%
    mutate(VORP_PER = as.numeric(VORP) + as.numeric(PER)) # Convert to numeric and sum
  
  return(nba_merge)
}

# Example usage: Get the cleaned dataset for the 2023 NBA season
nba_data_2023 <- get_cleaned_nba_stats(2023)

# View the first few rows of the cleaned dataset
head(nba_data_2023)


```

```{r}
# Load necessary libraries
library(dplyr)
library(rvest)

# Function to get NBA totals stats for a specified year
get_nba_totals_stats <- function(year) {
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_totals.html")
  webpage <- read_html(url)
  totals_stats_table <- webpage %>%
    html_node("table#totals_stats") %>%
    html_table(fill = TRUE)

  # Clean up column names
  colnames(totals_stats_table) <- make.names(colnames(totals_stats_table), unique = TRUE)

  # Clean the data
  totals_stats_table <- totals_stats_table %>%
    filter(!is.na(Player) & Player != "Player")  # Ensure no NA or duplicate header rows
  
  return(totals_stats_table)
}

# Function to get NBA advanced stats for a specified year
get_nba_advanced_stats <- function(year) {
  url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, "_advanced.html")
  webpage <- read_html(url)
  advanced_stats_table <- webpage %>%
    html_node("table#advanced_stats") %>%
    html_table(fill = TRUE)

  # Clean up column names
  colnames(advanced_stats_table) <- make.names(colnames(advanced_stats_table), unique = TRUE)

  # Clean the data
  advanced_stats_table <- advanced_stats_table %>%
    filter(!is.na(Player) & Player != "Player")  # Ensure no NA or duplicate header rows
  
  return(advanced_stats_table)
}

# Function to merge NBA totals and advanced stats for a specified year
get_cleaned_nba_stats <- function(year) {
  # Fetch totals and advanced stats
  nba_totals <- get_nba_totals_stats(year)
  nba_advanced <- get_nba_advanced_stats(year)

  # Identify common columns between the two datasets
  common_columns <- intersect(names(nba_totals), names(nba_advanced))

  # Check if the merge columns exist in both datasets
  merge_columns <- c("Player", "Pos", "Tm", "G", "MP")
  available_merge_columns <- intersect(merge_columns, common_columns)

  if (length(available_merge_columns) == 0) {
    stop("No valid columns to merge. Ensure that 'Player', 'Pos', 'Tm', 'G', 'MP' exist in both datasets.")
  }

  # Merge the datasets on the common columns
  nba_merge <- merge(nba_totals, nba_advanced, by = available_merge_columns, all.x = TRUE, all.y = TRUE)

  # Remove players whose team is "2Tm" or "3Tm" (case insensitive)
  nba_merge <- nba_merge %>%
    filter(!grepl("^[23]Tm$", Tm, ignore.case = TRUE))  # Remove rows with Tm as "2Tm" or "3Tm"

  # Merge columns Tm and Team into one column
  if ("Tm" %in% names(nba_merge)) {
    nba_merge <- nba_merge %>%
      mutate(Team = coalesce(Tm, Team)) %>%  # Merge Tm into Team
      select(-Tm)  # Remove the old Tm column
  }

  # Merge columns Rk.x and Rk.y
  if ("Rk.x" %in% names(nba_merge) & "Rk.y" %in% names(nba_merge)) {
    # Convert Rk.x and Rk.y to the same type
    nba_merge <- nba_merge %>%
      mutate(Rk = coalesce(as.character(Rk.x), as.character(Rk.y))) %>%
      select(-Rk.x, -Rk.y)  # Remove the old Rk.x and Rk.y columns
  }

  # Remove column age.y, keep age.x
  if ("age.y" %in% names(nba_merge)) {
    nba_merge <- nba_merge %>%
      select(-age.y)  # Remove age.y
  }

  # Remove the columns named "X" and "X.1" if they exist
  nba_merge <- nba_merge %>%
    select(-any_of(c("X", "X.1")), everything())  # Remove the "X" and "X.1" columns if they exist

  return(nba_merge)
}

# Example usage: Get the cleaned dataset for the 2023 NBA season
nba_data_2023 <- get_cleaned_nba_stats(2023)

# View the first few rows of the cleaned dataset
head(nba_data_2023)




```


```{r}
nba_data_2022 <-get_cleaned_nba_stats(2022)
nba_data_2010 <-get_cleaned_nba_stats(2010)
nba_data_2015 <-get_cleaned_nba_stats(2015)
```


**ASSIGNMENT 5:** *Make this file more visually appealng, with headers, bullet points, sections and subsections as you see fit. You may consider migrating over to Quarto for this reason.*



```{r}
# Save your dataframe as a CSV file
write.csv(nba_roster2, file = "generalstats.csv", row.names = FALSE)
write.csv(AO_nba_advanced_stats2, file = "advancedstats.csv", row.names = FALSE)
write.csv(nba_data_2023, file = "nba2023.csv", row.names = FALSE)
getwd()

```

